#!/bin/bash
# Install Arch Linux packages declaratively based on .chezmoidata/packages.yaml
# This script runs when the package list changes
# Only runs on desktop profile (Arch Linux)

{{ if and .include_defaults .is_desktop -}}
# Note: No set -e - package failures shouldn't break dotfiles install

# Check if paru is available
if ! command -v paru >/dev/null 2>&1; then
    echo "paru not found. Please install paru first:"
    echo "  git clone https://aur.archlinux.org/paru.git && cd paru && makepkg -si"
    exit 0  # Don't fail install, just skip
fi

# Update system (pacman only, skip AUR to avoid long builds)
echo "Updating system..."
sudo pacman -Syu --noconfirm || echo "Warning: System update had issues, continuing..."

# Collect missing packages
missing_packages=""
{{ if .arch.packages -}}
{{ range .arch.packages -}}
if ! pacman -Q "{{ . }}" >/dev/null 2>&1; then
    missing_packages="$missing_packages {{ . }}"
fi
{{ end -}}
{{ end -}}

# Install missing packages
if [ -n "$missing_packages" ]; then
    echo "Installing Arch packages:$missing_packages"
    paru -S --needed --noconfirm $missing_packages
    echo "Arch packages installed"
else
    echo "All Arch packages already installed"
fi

# Enable services
if pacman -Q tailscale >/dev/null 2>&1; then
    if ! systemctl is-enabled tailscaled >/dev/null 2>&1; then
        echo "Enabling tailscaled service..."
        sudo systemctl enable --now tailscaled
    fi
fi

# Device-conditional packages (installed when USB device is detected)
{{ if .arch.device_packages -}}
echo "Checking for device-conditional packages..."
usb_devices=$(lsusb 2>/dev/null | grep -oE '[0-9a-f]{4}:[0-9a-f]{4}' || true)

device_missing_packages=""
{{ range .arch.device_packages -}}
{{ $pkg := .name -}}
# Check for {{ $pkg }}
{{ range .usb_ids -}}
if echo "$usb_devices" | grep -qi "{{ . }}"; then
    if ! pacman -Q "{{ $pkg }}" >/dev/null 2>&1; then
        echo "Detected USB device {{ . }}, will install {{ $pkg }}"
        device_missing_packages="$device_missing_packages {{ $pkg }}"
    fi
fi
{{ end -}}
{{ end -}}

if [ -n "$device_missing_packages" ]; then
    echo "Installing device-conditional packages:$device_missing_packages"
    if ! paru -S --needed --noconfirm $device_missing_packages; then
        echo "Warning: Some device packages failed to install (possibly AUR issues)"
    else
        echo "Device-conditional packages installed"
    fi
else
    echo "No device-conditional packages to install"
fi
{{ end -}}

# GPU-conditional packages (NVIDIA)
{{ if .arch.gpu_packages.nvidia -}}
echo "Checking for NVIDIA GPU..."
if lspci 2>/dev/null | grep -qi "nvidia"; then
    echo "NVIDIA GPU detected"
    gpu_missing_packages=""
    {{ range .arch.gpu_packages.nvidia -}}
    if ! pacman -Q "{{ . }}" >/dev/null 2>&1; then
        gpu_missing_packages="$gpu_missing_packages {{ . }}"
    fi
    {{ end -}}

    if [ -n "$gpu_missing_packages" ]; then
        echo "Installing NVIDIA GPU packages:$gpu_missing_packages"
        if paru -S --needed --noconfirm $gpu_missing_packages; then
            echo "NVIDIA GPU packages installed"

            # Enable docker service
            if pacman -Q docker >/dev/null 2>&1; then
                if ! systemctl is-enabled docker >/dev/null 2>&1; then
                    echo "Enabling docker service..."
                    sudo systemctl enable --now docker
                fi

                # Add user to docker group
                if ! groups "$USER" | grep -q docker; then
                    echo "Adding $USER to docker group..."
                    sudo usermod -aG docker "$USER"
                    echo "NOTE: Log out and back in for docker group membership to take effect"
                fi
            fi

            # Configure nvidia-container-toolkit
            if pacman -Q nvidia-container-toolkit >/dev/null 2>&1; then
                if [ ! -f /etc/docker/daemon.json ] || ! grep -q "nvidia" /etc/docker/daemon.json 2>/dev/null; then
                    echo "Configuring NVIDIA container runtime..."
                    sudo nvidia-ctk runtime configure --runtime=docker
                    sudo systemctl restart docker
                fi
            fi
        else
            echo "Warning: Some GPU packages failed to install"
        fi
    else
        echo "All NVIDIA GPU packages already installed"
    fi
else
    echo "No NVIDIA GPU detected, skipping GPU packages"
fi
{{ end -}}

{{ else -}}
# Not a desktop profile, skip Arch package installation
{{ end -}}
