#!/bin/bash
set -e

{{ if .include_defaults -}}

# Check if running inside a Coder workspace
if [ "$CODER" = "true" ]; then

    # ========================================
    # Setup shared home directory structure
    # ========================================

    # Use DOTFILES_SHARED_HOME env var, default to /shared/home/default
    SHARED_HOME="${DOTFILES_SHARED_HOME:-/shared/home/default}"

    # Ensure shared home exists
    mkdir -p "$SHARED_HOME"

    # Seed missing files/directories from dotfiles/shared/ as defaults
    if [ -d "{{ .chezmoi.sourceDir }}/shared" ]; then
        for item in {{ .chezmoi.sourceDir }}/shared/*; do
            [ -e "$item" ] || continue

            basename_item=$(basename "$item")
            # Add dot prefix for home directory
            target="$SHARED_HOME/.$basename_item"

            # Only copy if it doesn't exist in shared home
            if [ ! -e "$target" ]; then
                cp -r "$item" "$target"
            fi
        done
    fi

    # First, symlink from /shared/home/shared/ (universal for all profiles)
    if [ -d "/shared/home/shared" ]; then
        for item in /shared/home/shared/.*; do
            [ -e "$item" ] || continue
            [ "$(basename "$item")" = "." ] && continue
            [ "$(basename "$item")" = ".." ] && continue

            basename_item=$(basename "$item")

            # Skip .config (managed by chezmoi)
            [ "$basename_item" = ".config" ] && continue

            # Target path in home directory
            target="$HOME/$basename_item"

            # Create symlink only if target doesn't exist
            if [ ! -e "$target" ]; then
                ln -sf "$item" "$target"
            fi
        done
    fi

    # Then, symlink from profile-specific shared home (can override shared)
    for item in "$SHARED_HOME"/.*; do
        [ -e "$item" ] || continue
        [ "$(basename "$item")" = "." ] && continue
        [ "$(basename "$item")" = ".." ] && continue

        basename_item=$(basename "$item")

        # Skip .config (managed by chezmoi)
        [ "$basename_item" = ".config" ] && continue

        # Target path in home directory
        target="$HOME/$basename_item"

        # Force symlink (overrides shared if exists)
        ln -sf "$item" "$target"
    done

    # ========================================
    # Setup GitHub CLI shared authentication
    # ========================================

    # Define shared GitHub CLI config path for maintainability
    GH_SHARED_CONFIG="/shared/.config/gh"

    # Seed /shared/.config/gh from dotfiles/shared/gh if it doesn't exist
    if [ -d "{{ .chezmoi.sourceDir }}/shared/gh" ] && [ ! -d "$GH_SHARED_CONFIG" ]; then
        echo "Seeding $GH_SHARED_CONFIG from dotfiles..."
        mkdir -p /shared/.config
        cp -r "{{ .chezmoi.sourceDir }}/shared/gh" "$GH_SHARED_CONFIG"
        chmod 600 "$GH_SHARED_CONFIG/hosts.yml" 2>/dev/null || true
        echo "✓ Created $GH_SHARED_CONFIG (update hosts.yml with your token)"
    fi

    # Create symlink from ~/.config/gh to /shared/.config/gh
    if [ -d "$GH_SHARED_CONFIG" ]; then
        echo "Setting up GitHub CLI shared authentication..."

        # Backup and remove existing gh config if it exists and is not a symlink
        if [ -e "$HOME/.config/gh" ] && [ ! -L "$HOME/.config/gh" ]; then
            echo "Backing up existing GitHub CLI config to $GH_SHARED_CONFIG.backup before removal..."
            timestamp=$(date +"%Y%m%d_%H%M%S")
            backup_dir="${GH_SHARED_CONFIG}.backup_$timestamp"
            cp -r "$HOME/.config/gh" "$backup_dir"
            echo "✓ Backed up to $backup_dir"
            rm -rf "$HOME/.config/gh"
        fi

        # Create the symlink (ensure parent directory exists)
        mkdir -p "$HOME/.config"
        ln -sfn "$GH_SHARED_CONFIG" "$HOME/.config/gh"
        echo "✓ GitHub CLI symlinked to $GH_SHARED_CONFIG"
    fi

else
    # Outside of Coder, symlink from dotfiles shared/ directory
    if [ -d "{{ .chezmoi.sourceDir }}/shared" ]; then
        for item in {{ .chezmoi.sourceDir }}/shared/*; do
            [ -e "$item" ] || continue
            basename_item=$(basename "$item")

            # Only symlink if doesn't exist in home (with dot prefix)
            if [ ! -e "$HOME/.$basename_item" ]; then
                ln -sf "$item" "$HOME/.$basename_item"
            fi
        done
    fi
fi
{{ end -}}