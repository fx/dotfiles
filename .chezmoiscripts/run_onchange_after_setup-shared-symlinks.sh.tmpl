#!/bin/bash
set -e

{{ if .include_defaults -}}

# Check if running inside a Coder workspace
if [ "$CODER" = "true" ]; then

    # ========================================
    # Setup shared home directory structure
    # ========================================

    # Use DOTFILES_SHARED_HOME env var, default to /shared/home/default
    SHARED_HOME="${DOTFILES_SHARED_HOME:-/shared/home/default}"

    # Ensure shared home exists
    mkdir -p "$SHARED_HOME"

    # Seed missing files/directories from dotfiles/shared/ as defaults
    if [ -d "{{ .chezmoi.sourceDir }}/shared" ]; then
        for item in {{ .chezmoi.sourceDir }}/shared/*; do
            [ -e "$item" ] || continue

            basename_item=$(basename "$item")
            # Add dot prefix for home directory
            target="$SHARED_HOME/.$basename_item"

            # Only copy if it doesn't exist in shared home
            if [ ! -e "$target" ]; then
                cp -r "$item" "$target"
            fi
        done
    fi

    # First, symlink from /shared/home/shared/ (universal for all profiles)
    if [ -d "/shared/home/shared" ]; then
        for item in /shared/home/shared/.*; do
            [ -e "$item" ] || continue
            [ "$(basename "$item")" = "." ] && continue
            [ "$(basename "$item")" = ".." ] && continue

            basename_item=$(basename "$item")

            # Skip .config (managed by chezmoi)
            [ "$basename_item" = ".config" ] && continue

            # Target path in home directory
            target="$HOME/$basename_item"

            # Create symlink only if target doesn't exist
            if [ ! -e "$target" ]; then
                ln -sf "$item" "$target"
            fi
        done
    fi

    # Then, symlink from profile-specific shared home (can override shared)
    for item in "$SHARED_HOME"/.*; do
        [ -e "$item" ] || continue
        [ "$(basename "$item")" = "." ] && continue
        [ "$(basename "$item")" = ".." ] && continue

        basename_item=$(basename "$item")

        # Skip .config (managed by chezmoi)
        [ "$basename_item" = ".config" ] && continue

        # Target path in home directory
        target="$HOME/$basename_item"

        # Force symlink (overrides shared if exists)
        ln -sf "$item" "$target"
    done

    # ========================================
    # Setup GitHub CLI shared authentication
    # ========================================
    if [ -d /shared/.config/gh ]; then
        echo "Setting up GitHub CLI shared authentication..."

        # Remove existing gh config if it exists and is not a symlink
        if [ -e "$HOME/.config/gh" ] && [ ! -L "$HOME/.config/gh" ]; then
            rm -rf "$HOME/.config/gh"
        fi

        # Create the symlink
        ln -sfn /shared/.config/gh "$HOME/.config/gh"
        echo "✓ GitHub CLI symlinked to /shared/.config/gh"
    else
        echo "⚠ /shared/.config/gh not found - GitHub CLI auth not configured"
        echo "  To set up shared authentication, create /shared/.config/gh/hosts.yml with your token"
    fi

else
    # Outside of Coder, symlink from dotfiles shared/ directory
    if [ -d "{{ .chezmoi.sourceDir }}/shared" ]; then
        for item in {{ .chezmoi.sourceDir }}/shared/*; do
            [ -e "$item" ] || continue
            basename_item=$(basename "$item")

            # Only symlink if doesn't exist in home (with dot prefix)
            if [ ! -e "$HOME/.$basename_item" ]; then
                ln -sf "$item" "$HOME/.$basename_item"
            fi
        done
    fi
fi
{{ end -}}