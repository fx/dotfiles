#!/bin/bash
set -e

{{ if eq .profile "coder" -}}

# Check if running inside a Coder workspace
if [ "$CODER" = "true" ]; then

    # ========================================
    # Generic shared dotfiles symlinking
    # ========================================

    # Use DOTFILES_SHARED_HOME env var, default to /shared/home
    SHARED_HOME="${DOTFILES_SHARED_HOME:-/shared/home}"

    # Ensure shared home exists
    mkdir -p "$SHARED_HOME"

    # If shared home is empty, seed it from dotfiles shared/ directory
    if [ -z "$(ls -A "$SHARED_HOME" 2>/dev/null)" ]; then
        if [ -d "{{ .chezmoi.sourceDir }}/shared" ]; then
            # Copy each item from shared/ to shared home with dot prefix
            for item in {{ .chezmoi.sourceDir }}/shared/*; do
                [ -e "$item" ] || continue
                basename_item=$(basename "$item")
                cp -r "$item" "$SHARED_HOME/.$basename_item"
            done
        fi
    fi

    # Symlink everything from shared home to $HOME
    for item in "$SHARED_HOME"/.[!.]* "$SHARED_HOME"/*; do
        # Skip if glob didn't match anything
        [ -e "$item" ] || continue

        # Get basename
        basename_item=$(basename "$item")

        # Skip .config (managed by chezmoi)
        [ "$basename_item" = ".config" ] && continue

        # Target path in home directory
        target="$HOME/$basename_item"

        # If target exists and is not already a symlink to the shared version, remove it
        if [ -e "$target" ] && [ "$(readlink -f "$target")" != "$item" ]; then
            rm -rf "$target"
        fi

        # Create symlink
        ln -sf "$item" "$target"
    done

else
    # Outside of Coder, symlink from dotfiles shared/ directory
    if [ -d "{{ .chezmoi.sourceDir }}/shared" ]; then
        for item in {{ .chezmoi.sourceDir }}/shared/*; do
            [ -e "$item" ] || continue
            basename_item=$(basename "$item")
            ln -sf "$item" "$HOME/.$basename_item"
        done
    fi
fi
{{ end -}}