#!/bin/bash
set -e

{{ if .include_defaults -}}

# Check if running inside a Coder workspace
if [ "$CODER" = "true" ]; then

    # ========================================
    # Setup shared home directory structure
    # ========================================

    # Use DOTFILES_SHARED_HOME env var, default to /shared/home/default
    SHARED_HOME="${DOTFILES_SHARED_HOME:-/shared/home/default}"

    # Ensure shared home exists
    mkdir -p "$SHARED_HOME"

    # Seed missing files/directories from dotfiles/shared/ as defaults
    if [ -d "{{ .chezmoi.sourceDir }}/shared" ]; then
        for item in {{ .chezmoi.sourceDir }}/shared/*; do
            [ -e "$item" ] || continue

            basename_item=$(basename "$item")
            # Add dot prefix for home directory
            target="$SHARED_HOME/.$basename_item"

            # Only copy if it doesn't exist in shared home
            if [ ! -e "$target" ]; then
                cp -r "$item" "$target"
            fi
        done
    fi

    # Symlink from shared home to $HOME, but only for items that don't exist in $HOME
    for item in "$SHARED_HOME"/.*; do
        [ -e "$item" ] || continue
        [ "$(basename "$item")" = "." ] && continue
        [ "$(basename "$item")" = ".." ] && continue

        basename_item=$(basename "$item")

        # Skip .config (managed by chezmoi)
        [ "$basename_item" = ".config" ] && continue

        # Target path in home directory
        target="$HOME/$basename_item"

        # If target doesn't exist, create symlink
        if [ ! -e "$target" ]; then
            ln -sf "$item" "$target"
        fi
    done

else
    # Outside of Coder, symlink from dotfiles shared/ directory
    if [ -d "{{ .chezmoi.sourceDir }}/shared" ]; then
        for item in {{ .chezmoi.sourceDir }}/shared/*; do
            [ -e "$item" ] || continue
            basename_item=$(basename "$item")

            # Only symlink if doesn't exist in home (with dot prefix)
            if [ ! -e "$HOME/.$basename_item" ]; then
                ln -sf "$item" "$HOME/.$basename_item"
            fi
        done
    fi
fi
{{ end -}}