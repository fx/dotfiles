#!/bin/bash
# Configure WirePlumber for NVIDIA HDMI audio
# Disables suspend to prevent audio dropouts
# Only runs on desktop profile with NVIDIA GPU

{{ if .is_desktop -}}
# Check for NVIDIA GPU
if lspci 2>/dev/null | grep -qi "nvidia"; then
    echo "NVIDIA GPU detected, configuring WirePlumber..."

    config_dir="$HOME/.config/wireplumber/wireplumber.conf.d"
    config_file="$config_dir/51-disable-suspend.conf"

    # Create config directory if needed
    mkdir -p "$config_dir"

    # Create config to disable suspend for NVIDIA HDMI audio
    if [ ! -f "$config_file" ]; then
        cat > "$config_file" << 'EOF'
# Disable suspend for NVIDIA HDMI audio to prevent dropouts
monitor.alsa.rules = [
  {
    matches = [
      { node.name = "~alsa_output.pci-0000_01_00.*" }
    ]
    actions = {
      update-props = {
        session.suspend-timeout-seconds = 0
      }
    }
  }
]
EOF
        echo "âœ“ WirePlumber config created: $config_file"

        # Restart WirePlumber to apply changes
        if systemctl --user is-active wireplumber >/dev/null 2>&1; then
            echo "Restarting WirePlumber..."
            systemctl --user restart wireplumber
        fi
    else
        echo "WirePlumber NVIDIA audio config already exists"
    fi

    # Enable NVIDIA persistence mode if nvidia-persistenced is available
    if command -v nvidia-persistenced >/dev/null 2>&1; then
        if ! systemctl is-enabled nvidia-persistenced >/dev/null 2>&1; then
            echo "Enabling NVIDIA persistence daemon..."
            sudo systemctl enable nvidia-persistenced 2>/dev/null || true
        fi
    fi
fi
{{ else -}}
# Not a desktop profile, skip WirePlumber configuration
{{ end -}}
